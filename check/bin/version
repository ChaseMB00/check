#!/usr/bin/env php
<?php

/**
 * Contao Open Source CMS
 *
 * Copyright (C) 2005-2012 Leo Feyer
 *
 * @package Check
 * @link    http://contao.org
 * @license http://www.gnu.org/licenses/lgpl-3.0.html LGPL
 */

error_reporting(E_ALL^E_NOTICE);

// Validate the given path
if (empty($argv[1])) {
	die("Please provide the installation path as argument\n");
}
if (!is_dir($argv[1]) || !file_exists($argv[1] . '/system/initialize.php')) {
	die("The installation path does not exist or does not point to a Contao installation\n");
}

define('TL_ROOT', $argv[1]);

// Include the constants.php file
if (file_exists($argv[1] . '/system/constants.php')) {
	include $argv[1] . '/system/constants.php';
} elseif (file_exists($argv[1] . '/system/config/constants.php')) {
	include $argv[1] . '/system/config/constants.php';
}

// Get the git ignores
$ignore = explode("\n", str_replace('Would remove ', '', trim(shell_exec("cd {$argv[1]} && LANG=en_US git clean -dfnx"))));

if (!is_array($ignore) || empty($ignore)) {
	die("The git ignore list is empty, which is rather unlikely\n");
}

$json = array();

// Get all files
$it = new RecursiveIteratorIterator(
	new RecursiveDirectoryIterator($argv[1], FilesystemIterator::UNIX_PATHS)
);

// Excludes
while ($it->valid()) {
	if ($it->isDot() || $it->isDir()) {
		$it->next(); continue;
	}

	// System and IDE files
	if ($it->getFilename() == '.DS_Store') {
		$it->next(); continue;
	}
	if (strncmp($it->getSubPathname(), '.git/', 5) === 0) {
		$it->next(); continue;
	}
	if (strncmp($it->getSubPathname(), '.tx/', 3) === 0) {
		$it->next(); continue;
	}
	if (strncmp($it->getSubPathname(), '.idea/', 6) === 0) {
		$it->next(); continue;
	}

	// Ignores
	if (in_array($it->getSubPathname(), $ignore)) {
		$it->next(); continue;
	}

	// Store the file name and hashes
	$buffer = str_replace("\r", '', file_get_contents($it->getPathname()));
	$json[] = array($it->getSubPathname(), substr(md5($buffer), 0, 10));

	echo '  Added ' . $it->getSubPathname() . "\n";

	$it->next();
	unset($buffer);
}

// Store the JSON file
file_put_contents('check/versions/' . VERSION . '.' . BUILD . '.json', json_encode($json));
echo 'Added check/versions/' . VERSION . '.' . BUILD . '.json' . "\n";
